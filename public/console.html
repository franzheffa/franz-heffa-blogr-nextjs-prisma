<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Buttertech • Console</title>
<link rel="stylesheet" href="/assets/brand.css"/>
</head><body>
<div class="container">
  <div class="badge">✅ Gateway & API proxy actifs</div>
  <h1>Console IA (stream + voix)</h1>
  <p class="lead">Testez l’agent <b>Gemini 2.5</b> en streaming. Option “Parler” génère l’audio côté gateway.</p>

  <div class="card">
    <form id="f" onsubmit="return false;">
      <input id="q" class="input" placeholder="Posez une question…" style="width:100%;margin-bottom:10px"/>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
        <input id="img" class="input" placeholder="https://exemple/image.jpg (optionnel)" style="flex:1"/>
        <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="speak"> Parler</label>
        <button id="go" class="btn gold">Générer</button>
      </div>
    </form>
    <pre id="out" class="stream mono"></pre>
    <audio id="player" controls style="margin-top:10px;display:none"></audio>
  </div>
</div>

<script>
const out = document.getElementById('out');
const btn = document.getElementById('go');
const q   = document.getElementById('q');
const img = document.getElementById('img');
const speak = document.getElementById('speak');
const player = document.getElementById('player');

async function streamChat() {
  out.textContent = ''; player.style.display='none'; player.removeAttribute('src');
  btn.disabled = true;
  const r = await fetch('/api/agents/gemini?stream=1', {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ prompt: q.value || 'Bonjour', imageUrl: img.value || null })
  });
  if (!r.body) { out.textContent = await r.text(); btn.disabled=false; return; }
  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  while (true) {
    const {value, done} = await reader.read();
    if (done) break;
    out.textContent += decoder.decode(value, {stream:true});
  }
  // Option "Parler"
  if (speak.checked) {
    const rr = await fetch('/api/voice/tts', {method:'POST', body: out.textContent});
    const blob = await rr.blob();
    player.src = URL.createObjectURL(blob);
    player.style.display='block';
    player.play().catch(()=>{});
  }
  btn.disabled = false;
}
document.getElementById('f').addEventListener('submit', streamChat);
btn.addEventListener('click', streamChat);
</script>
</body></html>
